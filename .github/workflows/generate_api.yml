name: Generate Morningstar API

on:
  push:
  workflow_dispatch:
  schedule:
    # This cron expression schedules the workflow to run at 00:00 on the first day of every month
    - cron: '0 0 1 * *'

env:
  PACKAGE_NAME: morningstar
  OPENAPI_SPEC: morningstarOpenApi.json

jobs:
  process-yaml:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: 'current-repo'      
          ref: autogeneratedAPI # Checkout the autogeneratedAPI branch

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: 'mathworks-ref-arch/matlab-openapi-generator'      
          path: 'external-repo'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Specify the Node.js version you want to use

      - name: Set up Rust
        uses:  actions-rs/toolchain@v1
        with:
          toolchain: 'stable'

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'adopt'
          java-version: '11'
          cache: 'maven'

      - name: Create openAPI spec
        run: |
          cargo install postman2openapi-cli
          postman2openapi $GITHUB_WORKSPACE/current-repo/${{ env.OPENAPI_SPEC }} > $GITHUB_WORKSPACE/current-repo/openapi.yaml

      - name: Run Maven Package
        run: |
          cd external-repo/Software/Java
          mvn -q clean package

      - name: Generate API
        run: |
          cd external-repo/Software
          npx @openapitools/openapi-generator-cli --custom-generator MATLAB/lib/jar/MATLABClientCodegen-openapi-generator-0.0.1.jar generate -g MATLAB -i $GITHUB_WORKSPACE/current-repo/openapi.yaml -o ${{ env.PACKAGE_NAME }} --package-name ${{ env.PACKAGE_NAME }} -p AddOAuth=auth

      - name: Configure Git
        run: |    
          cp -r external-repo/Software/${{ env.PACKAGE_NAME }} current-repo/tbx/
          cd current-repo
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and Push changes
        run: |
          cd current-repo
          git add .
          # Check if there are any changes to commit
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit."
          else
            git commit -m "Update generated MATLAB API"
            git push origin autogeneratedAPI
          fi          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
